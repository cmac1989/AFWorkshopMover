<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #spinnerOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }
    </style>
</head>
<body class="p-3">
<h3>Workshop Dashboard</h3>
<div class="mb-2">
    <button id="refresh" class="btn btn-primary btn-sm">Refresh</button>
    <button id="sendEmail" class="btn btn-success btn-sm">Send Email</button>
</div>

<div id="logs"></div>

<div id="spinnerOverlay">
    <div class="spinner-border text-primary" role="status" style="width:3rem; height:3rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<script>
    const spinner = document.getElementById('spinnerOverlay');

    function showSpinner() { spinner.style.display = 'flex'; }
    function hideSpinner() { spinner.style.display = 'none'; }

    function renderLogs() {
        showSpinner();
        google.script.run.withSuccessHandler(fillTable).getWorkshopLogs();
    }

    function fillTable(logEntries) {
        hideSpinner();
        if (!logEntries || logEntries.length === 0) {
            document.getElementById('logs').innerHTML = 'No logs to display';
            return;
        }

        let html = `<table class="table table-striped table-bordered">
    <thead class="table-dark">
      <tr>
        <th>âœ”</th>
        <th>Row Moved To</th>
        <th>Type</th>
        <th>Details</th>
      </tr>
    </thead>
    <tbody>`;

        logEntries.forEach((entry, index) => {
            let details = entry.details;

            if (typeof details === 'object') {
                details = Object.entries(details)
                    .map(([k,v]) => `<strong>${k}:</strong> ${v}`)
                    .join('<br>');
            }

            html += `<tr>
      <td style="text-align:center;">
        <input type="checkbox" class="log-checkbox" data-index="${index}" checked>
      </td>
      <td>${entry.rowIndex || 'N/A'}</td>
      <td>${entry.type}</td>
      <td>${details}</td>
    </tr>`;
        });

        html += '</tbody></table>';
        document.getElementById('logs').innerHTML = html;
    }

    document.getElementById('refresh').addEventListener('click', renderLogs);

    document.getElementById('sendEmail').addEventListener('click', () => {
        const selectedIndexes = Array.from(document.querySelectorAll('.log-checkbox'))
            .filter(cb => cb.checked)
            .map(cb => parseInt(cb.dataset.index));

        if (selectedIndexes.length === 0) { alert('Select at least one entry.'); return; }

        showSpinner();
        google.script.run.withSuccessHandler(msg => {
            alert(msg);
            hideSpinner();
        }).sendSelectedLogsEmail(selectedIndexes);
    });

    // Initial load
    renderLogs();
</script>
</body>
</html>
